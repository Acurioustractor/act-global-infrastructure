name: Daily Health Check

on:
  schedule:
    # Run daily at 5 PM UTC (2 PM EST, 8 AM AEST next day)
    - cron: '0 17 * * *'
  workflow_dispatch: # Manual trigger

permissions:
  issues: write
  contents: read

jobs:
  health-check:
    name: Monitor Deployment Health
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run deployment health check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        run: |
          echo "üè• Running deployment health check..."
          node scripts/deployment-intelligence.mjs --days=1

      - name: Check all sites
        run: |
          echo "üåê Checking all 7 production sites..."

          # Array of sites to check
          declare -a sites=(
            "https://act.place"
            "https://empathy-ledger.vercel.app"
            "https://justicehub.vercel.app"
            "https://theharvest.vercel.app"
            "https://goods.vercel.app"
            "https://actfarm.org.au"
            "https://act-placemat.vercel.app"
          )

          failed_sites=()

          for site in "${sites[@]}"
          do
            echo "Checking $site..."
            response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$site" || echo "000")

            if [ "$response" = "200" ] || [ "$response" = "301" ] || [ "$response" = "302" ]; then
              echo "  ‚úÖ $site - HTTP $response"
            else
              echo "  ‚ùå $site - HTTP $response (FAILED)"
              failed_sites+=("$site")
            fi
          done

          if [ ${#failed_sites[@]} -gt 0 ]; then
            echo ""
            echo "‚ö†Ô∏è  Failed sites: ${failed_sites[*]}"
            exit 1
          else
            echo ""
            echo "‚úÖ All sites healthy!"
          fi

      - name: Create issue if health check fails
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = 'üö® Daily Health Check Failed';
            const body = `
            ## Health Check Failure

            The daily health check detected issues with one or more sites.

            **Timestamp**: ${new Date().toISOString()}

            **Action Required**:
            1. Check the [workflow run logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. Identify which site(s) failed
            3. Investigate and resolve the issue
            4. Run manual health check to verify: \`npm run deploy:analyze\`

            **Failed in**: \`daily-health-check.yml\` workflow

            ---
            ü§ñ Auto-generated by daily health monitoring
            `;

            // Create issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['Type: Bug', 'Priority: High', 'automated']
            });
