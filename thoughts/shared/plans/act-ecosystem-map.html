<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ACT Ecosystem ‚Äî Data Flow Architecture</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: #0a0a0f; color: #e2e8f0; overflow: hidden; height: 100vh; }

/* Header */
.header { display: flex; align-items: center; justify-content: space-between; padding: 12px 24px; background: #111118; border-bottom: 1px solid #1e1e2e; }
.header h1 { font-size: 16px; font-weight: 600; color: #f1f5f9; }
.header .stats { font-size: 12px; color: #64748b; display: flex; gap: 16px; }
.header .stats span { display: flex; align-items: center; gap: 4px; }
.header .stats .dot { width: 6px; height: 6px; border-radius: 50%; }

/* Tabs */
.tabs { display: flex; gap: 0; background: #111118; border-bottom: 1px solid #1e1e2e; padding: 0 24px; }
.tab { padding: 10px 20px; font-size: 13px; color: #64748b; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; user-select: none; }
.tab:hover { color: #94a3b8; }
.tab.active { color: #f1f5f9; border-bottom-color: #3b82f6; }

/* Main canvas */
.canvas-wrap { height: calc(100vh - 95px); overflow: auto; position: relative; }
.tab-content { display: none; height: 100%; }
.tab-content.active { display: block; }

/* SVG canvas */
svg.diagram { width: 100%; height: 100%; }

/* Tooltip */
.tooltip { position: fixed; background: #1e1e2e; border: 1px solid #2d2d3f; border-radius: 8px; padding: 12px 16px; font-size: 12px; max-width: 320px; pointer-events: none; z-index: 100; opacity: 0; transition: opacity 0.15s; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
.tooltip.show { opacity: 1; }
.tooltip h4 { font-size: 13px; color: #f1f5f9; margin-bottom: 6px; }
.tooltip .detail { color: #94a3b8; line-height: 1.5; }
.tooltip .tag { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; margin-top: 4px; }
.tag-green { background: #064e3b; color: #6ee7b7; }
.tag-orange { background: #78350f; color: #fbbf24; }
.tag-red { background: #7f1d1d; color: #fca5a5; }
.tag-blue { background: #1e3a5f; color: #93c5fd; }

/* Legend */
.legend { position: absolute; bottom: 16px; left: 16px; background: #111118ee; border: 1px solid #1e1e2e; border-radius: 8px; padding: 12px 16px; font-size: 11px; z-index: 50; }
.legend h5 { font-size: 11px; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
.legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; color: #94a3b8; }
.legend-line { width: 24px; height: 2px; border-radius: 1px; }

/* Tab 2: Duplication */
.dup-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 16px; padding: 24px; overflow-y: auto; height: 100%; }
.dup-card { background: #111118; border: 1px solid #1e1e2e; border-radius: 10px; padding: 20px; }
.dup-card h3 { font-size: 15px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.dup-card .copies { display: flex; flex-direction: column; gap: 8px; }
.copy-row { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 6px; background: #0a0a0f; font-size: 12px; }
.copy-row .system { font-weight: 600; min-width: 100px; }
.copy-row .role { color: #94a3b8; flex: 1; }
.copy-row .sot { padding: 2px 8px; border-radius: 3px; font-size: 10px; font-weight: 700; }
.sot-primary { background: #064e3b; color: #6ee7b7; }
.sot-mirror { background: #1e293b; color: #64748b; }
.sot-sync { background: #1e3a5f; color: #93c5fd; }
.dup-verdict { margin-top: 12px; padding: 10px 12px; border-radius: 6px; font-size: 12px; line-height: 1.5; }
.verdict-ok { background: #064e3b33; border-left: 3px solid #10b981; color: #6ee7b7; }
.verdict-warn { background: #78350f33; border-left: 3px solid #f59e0b; color: #fbbf24; }
.verdict-risk { background: #7f1d1d33; border-left: 3px solid #ef4444; color: #fca5a5; }

/* Tab 3: Health */
.health-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; padding: 24px; overflow-y: auto; height: 100%; }
.health-card { background: #111118; border: 1px solid #1e1e2e; border-radius: 10px; padding: 16px; display: flex; gap: 12px; align-items: flex-start; }
.health-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
.health-green .health-icon { background: #064e3b; }
.health-orange .health-icon { background: #78350f; }
.health-red .health-icon { background: #7f1d1d; }
.health-blue .health-icon { background: #1e3a5f; }
.health-info h4 { font-size: 13px; margin-bottom: 4px; }
.health-info p { font-size: 12px; color: #94a3b8; line-height: 1.5; }
.health-info .fix { margin-top: 6px; font-size: 11px; color: #f59e0b; font-style: italic; }

/* Tab 4: Agentic */
.agent-wrap { padding: 24px; overflow-y: auto; height: 100%; }
.agent-section { margin-bottom: 32px; }
.agent-section h3 { font-size: 15px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.agent-section h3 .count { font-size: 11px; color: #64748b; font-weight: 400; }
.agent-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 10px; }
.agent-item { display: flex; gap: 12px; padding: 12px 16px; background: #111118; border: 1px solid #1e1e2e; border-radius: 8px; align-items: flex-start; }
.agent-dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 5px; flex-shrink: 0; }
.agent-item h5 { font-size: 13px; margin-bottom: 2px; }
.agent-item p { font-size: 11px; color: #94a3b8; line-height: 1.4; }
.dot-active { background: #10b981; box-shadow: 0 0 6px #10b98166; }
.dot-opportunity { background: #f59e0b; box-shadow: 0 0 6px #f59e0b44; }
.dot-planned { background: #3b82f6; box-shadow: 0 0 6px #3b82f644; }
.priority-badge { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 9px; font-weight: 700; margin-left: 6px; vertical-align: middle; }
.pri-high { background: #7f1d1d; color: #fca5a5; }
.pri-med { background: #78350f; color: #fbbf24; }
.pri-low { background: #1e293b; color: #94a3b8; }

/* Tab 5: Process */
.process-wrap { padding: 24px; overflow-y: auto; height: 100%; }
.process-card { background: #111118; border: 1px solid #1e1e2e; border-radius: 10px; padding: 24px; margin-bottom: 20px; }
.process-card h3 { font-size: 15px; margin-bottom: 4px; }
.process-card .subtitle { font-size: 12px; color: #64748b; margin-bottom: 16px; }
.process-steps { display: flex; flex-wrap: wrap; gap: 0; align-items: center; }
.process-step { padding: 8px 14px; border-radius: 6px; font-size: 12px; font-weight: 500; position: relative; white-space: nowrap; }
.process-arrow { color: #334155; font-size: 16px; padding: 0 4px; flex-shrink: 0; }
.step-external { background: #1e293b; color: #94a3b8; border: 1px solid #334155; }
.step-supabase { background: #064e3b; color: #6ee7b7; border: 1px solid #10b981; }
.step-ai { background: #312e81; color: #a5b4fc; border: 1px solid #6366f1; }
.step-output { background: #1e3a5f; color: #93c5fd; border: 1px solid #3b82f6; }
.step-blocked { background: #7f1d1d; color: #fca5a5; border: 1px solid #ef4444; }
.process-meta { display: flex; gap: 20px; margin-top: 12px; font-size: 11px; color: #64748b; }
.process-meta span { display: flex; align-items: center; gap: 4px; }

/* Filter bar for tab 1 */
.filter-bar { position: absolute; top: 12px; right: 16px; display: flex; gap: 8px; z-index: 50; }
.filter-btn { padding: 4px 10px; border-radius: 4px; font-size: 11px; background: #1e1e2e; border: 1px solid #2d2d3f; color: #94a3b8; cursor: pointer; transition: all 0.15s; }
.filter-btn:hover { border-color: #3b82f6; color: #e2e8f0; }
.filter-btn.active { background: #1e3a5f; border-color: #3b82f6; color: #93c5fd; }

/* Prompt output */
.prompt-bar { position: absolute; bottom: 16px; right: 16px; z-index: 50; }
.prompt-toggle { padding: 6px 12px; border-radius: 6px; font-size: 11px; background: #1e1e2e; border: 1px solid #2d2d3f; color: #94a3b8; cursor: pointer; }
.prompt-toggle:hover { border-color: #3b82f6; color: #e2e8f0; }
.prompt-panel { position: absolute; bottom: 40px; right: 0; width: 480px; max-height: 400px; background: #111118; border: 1px solid #1e1e2e; border-radius: 10px; padding: 16px; display: none; overflow-y: auto; }
.prompt-panel.show { display: block; }
.prompt-panel pre { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 11px; color: #94a3b8; white-space: pre-wrap; line-height: 1.6; }
.copy-btn { position: absolute; top: 12px; right: 12px; padding: 4px 10px; border-radius: 4px; font-size: 10px; background: #3b82f6; border: none; color: white; cursor: pointer; }
.copy-btn:hover { background: #2563eb; }
</style>
</head>
<body>

<div class="header">
  <h1>ACT Ecosystem ‚Äî Data Flow Architecture</h1>
  <div class="stats">
    <span><span class="dot" style="background:#10b981"></span> 65+ tables</span>
    <span><span class="dot" style="background:#3b82f6"></span> 163 API routes</span>
    <span><span class="dot" style="background:#f59e0b"></span> 28 cron jobs</span>
    <span><span class="dot" style="background:#a78bfa"></span> 40 bot tools</span>
    <span><span class="dot" style="background:#64748b"></span> 8 external systems</span>
  </div>
</div>

<div class="tabs">
  <div class="tab active" data-tab="flow">Live Data Flow</div>
  <div class="tab" data-tab="duplication">Duplication Analysis</div>
  <div class="tab" data-tab="health">Health Assessment</div>
  <div class="tab" data-tab="agentic">Agentic Opportunities</div>
  <div class="tab" data-tab="process">Process Maps</div>
</div>

<div class="canvas-wrap">
  <!-- Tooltip -->
  <div class="tooltip" id="tooltip"></div>

  <!-- TAB 1: LIVE DATA FLOW -->
  <div class="tab-content active" id="tab-flow" style="position:relative">
    <div class="filter-bar" id="filters"></div>
    <svg class="diagram" id="flow-svg" xmlns="http://www.w3.org/2000/svg"></svg>
    <div class="legend" id="flow-legend">
      <h5>Connection Status</h5>
      <div class="legend-item"><div class="legend-line" style="background:#10b981"></div> Healthy (real-time / frequent)</div>
      <div class="legend-item"><div class="legend-line" style="background:#f59e0b"></div> Needs attention (slow / issues)</div>
      <div class="legend-item"><div class="legend-line" style="background:#ef4444"></div> Broken / blocked</div>
      <div class="legend-item"><div class="legend-line" style="background:#3b82f6;opacity:0.6"></div> New / trial phase</div>
      <div class="legend-item"><div class="legend-line" style="background:#64748b;border-top:2px dashed #64748b;height:0"></div> Planned (not built)</div>
    </div>
    <div class="prompt-bar">
      <button class="prompt-toggle" onclick="togglePrompt()">Audit Summary</button>
      <div class="prompt-panel" id="prompt-panel">
        <button class="copy-btn" onclick="copyPrompt()">Copy</button>
        <pre id="prompt-text"></pre>
      </div>
    </div>
  </div>

  <!-- TAB 2: DUPLICATION ANALYSIS -->
  <div class="tab-content" id="tab-duplication">
    <div class="dup-grid" id="dup-grid"></div>
  </div>

  <!-- TAB 3: HEALTH ASSESSMENT -->
  <div class="tab-content" id="tab-health">
    <div class="health-grid" id="health-grid"></div>
  </div>

  <!-- TAB 4: AGENTIC OPPORTUNITIES -->
  <div class="tab-content" id="tab-agentic">
    <div class="agent-wrap" id="agent-wrap"></div>
  </div>

  <!-- TAB 5: PROCESS MAPS -->
  <div class="tab-content" id="tab-process">
    <div class="process-wrap" id="process-wrap"></div>
  </div>
</div>

<script>
// ============================================================
// DATA
// ============================================================

const sources = [
  { id: 'gmail', label: 'Gmail', sub: '4 mailboxes', icon: 'üìß', x: 60, y: 80, color: '#ef4444' },
  { id: 'gcal', label: 'Google Calendar', sub: 'Multi-calendar', icon: 'üìÖ', x: 60, y: 170, color: '#4285f4' },
  { id: 'ghl', label: 'GHL CRM', sub: '~5K contacts', icon: 'üë•', x: 60, y: 260, color: '#10b981' },
  { id: 'xero', label: 'Xero', sub: 'Webhooks + API', icon: 'üí∞', x: 60, y: 350, color: '#13b5ea' },
  { id: 'notion', label: 'Notion', sub: '27 databases', icon: 'üìù', x: 60, y: 440, color: '#ffffff' },
  { id: 'github', label: 'GitHub', sub: 'Issues + drafts', icon: 'üîß', x: 60, y: 530, color: '#8b5cf6' },
  { id: 'imessage', label: 'iMessage', sub: 'Local sync', icon: 'üí¨', x: 60, y: 610, color: '#34d399' },
  { id: 'webscrape', label: 'Grant Sources', sub: 'Daily scrape', icon: 'üåê', x: 60, y: 690, color: '#f59e0b' },
];

const supaDomains = [
  { id: 'sb-contacts', label: 'Contacts & CRM', sub: '7 tables, 3 views', tables: 'ghl_contacts, cultural_protocols, relationship_health', x: 420, y: 60, color: '#10b981' },
  { id: 'sb-finance', label: 'Finance', sub: '19 tables, 11 views', tables: 'xero_transactions, xero_invoices, subscriptions, assets', x: 420, y: 150, color: '#13b5ea' },
  { id: 'sb-comms', label: 'Communications', sub: '3 tables, 4 views', tables: 'communications_history, user_identities', x: 420, y: 240, color: '#ef4444' },
  { id: 'sb-projects', label: 'Projects', sub: '7 tables, 7 views', tables: 'projects, project_knowledge, project_health, sprint_items', x: 420, y: 330, color: '#a78bfa' },
  { id: 'sb-grants', label: 'Grants', sub: '4 tables, 4 views', tables: 'grant_opportunities, grant_applications', x: 420, y: 420, color: '#f59e0b' },
  { id: 'sb-calendar', label: 'Calendar', sub: '1 table, 2 views', tables: 'calendar_events', x: 420, y: 500, color: '#4285f4' },
  { id: 'sb-memory', label: 'Memory', sub: '6 tables', tables: 'knowledge_chunks, knowledge_edges, memory_episodes', x: 420, y: 580, color: '#e879f9' },
  { id: 'sb-learning', label: 'Agent Learning', sub: '4 tables', tables: 'feedback, mistakes, confidence, autonomy', x: 420, y: 660, color: '#fb923c' },
  { id: 'sb-ops', label: 'Operations', sub: '4 tables', tables: 'integration_events, webhook_logs, sync_state', x: 420, y: 740, color: '#64748b' },
];

const consumers = [
  { id: 'bot', label: 'Telegram Bot', sub: '40 tools', icon: 'ü§ñ', x: 780, y: 120, color: '#3b82f6' },
  { id: 'dashboard', label: 'Command Center', sub: '163 routes', icon: 'üìä', x: 780, y: 240, color: '#10b981' },
  { id: 'notion-agents', label: 'Notion Agents', sub: '3 trial agents', icon: 'üß†', x: 780, y: 360, color: '#3b82f6' },
  { id: 'cron', label: 'Cron Scripts', sub: '28 PM2 jobs', icon: '‚è∞', x: 780, y: 480, color: '#f59e0b' },
  { id: 'ai', label: 'AI Enrichment', sub: 'Claude + OpenAI', icon: '‚ú®', x: 780, y: 600, color: '#a78bfa' },
];

const connections = [
  // Sources ‚Üí Supabase
  { from: 'gmail', to: 'sb-comms', label: 'Every 6h', status: 'orange', bidir: false, detail: '4 mailboxes. Slow for 90-day backfill, DNS failures under load.' },
  { from: 'gmail', to: 'sb-contacts', label: 'Contact match', status: 'orange', bidir: false, detail: 'Auto-matches sender to GHL contacts. New contact creation BLOCKED (missing source column).' },
  { from: 'gcal', to: 'sb-calendar', label: 'Every 6h', status: 'green', bidir: true, detail: 'Bidirectional: Calendar‚ÜíSB sync + Notion dates‚ÜíCalendar publish.' },
  { from: 'ghl', to: 'sb-contacts', label: 'Webhooks + 6h', status: 'green', bidir: true, detail: 'Real-time webhooks + hourly cron fallback. Cultural protocol fields BLOCKED from GHL.' },
  { from: 'ghl', to: 'sb-grants', label: 'Every 6h', status: 'green', bidir: true, detail: 'Grants pipeline bidirectional sync. Stage mapping: not_applied‚ÜîIdentified, in_progress‚ÜîIn Progress, submitted‚ÜîSubmitted.' },
  { from: 'xero', to: 'sb-finance', label: 'Webhooks', status: 'green', bidir: false, detail: 'Real-time webhooks (HMAC validated). Transactions + invoices + contacts. Supabase is read-only mirror.' },
  { from: 'notion', to: 'sb-projects', label: 'Every 5 min', status: 'green', bidir: true, detail: 'Bidirectional: Notion‚ÜíSB knowledge + SB‚ÜíNotion actions/decisions/intelligence. Checkboxes synced every 15 min.' },
  { from: 'notion', to: 'sb-comms', label: 'Meetings', status: 'green', bidir: true, detail: 'Meeting notes synced daily. Actions/decisions every 15 min.' },
  { from: 'github', to: 'sb-projects', label: 'On demand', status: 'green', bidir: true, detail: 'Issues‚ÜíNotion sprint tracking. Writing drafts via GitHub Contents API.' },
  { from: 'imessage', to: 'sb-comms', label: 'Every 15 min', status: 'green', bidir: false, detail: 'Local SQLite‚ÜíSupabase. Includes OCR on attachments, vector embeddings.' },
  { from: 'webscrape', to: 'sb-grants', label: 'Daily', status: 'orange', bidir: false, detail: 'Grant discovery from web. 8 gov.au URLs blocked (403/404). AI scoring with Claude.' },
  // Supabase ‚Üí Consumers
  { from: 'sb-contacts', to: 'bot', label: 'Real-time', status: 'green', bidir: false, detail: '8 contact tools: search, details, attention, deal risks, health.' },
  { from: 'sb-finance', to: 'bot', label: 'Real-time', status: 'green', bidir: false, detail: 'Financial summary, transactions, cashflow, receipts, project financials.' },
  { from: 'sb-projects', to: 'bot', label: 'Real-time', status: 'green', bidir: false, detail: 'Project summary, health, 360 view, knowledge search, ecosystem pulse.' },
  { from: 'sb-grants', to: 'bot', label: 'Real-time', status: 'green', bidir: false, detail: 'Grant opportunities, pipeline status, upcoming deadlines.' },
  { from: 'sb-comms', to: 'bot', label: 'Real-time', status: 'green', bidir: false, detail: 'Email search, day context, daily briefing.' },
  { from: 'sb-contacts', to: 'dashboard', label: '11 routes', status: 'green', bidir: false, detail: 'Contact CRUD, search, duplicates, merge, interactions, opportunities.' },
  { from: 'sb-finance', to: 'dashboard', label: '16 routes', status: 'green', bidir: false, detail: 'Transactions, invoices, P&L, cashflow, tax, R&D tracking, runway.' },
  { from: 'sb-projects', to: 'dashboard', label: '12 routes', status: 'green', bidir: false, detail: 'Project summary, financials, alignment, pulse, health history.' },
  { from: 'sb-grants', to: 'dashboard', label: '8 routes', status: 'green', bidir: false, detail: 'Opportunities, pipeline, draft editing, milestones, readiness.' },
  { from: 'sb-projects', to: 'notion-agents', label: 'Trial API', status: 'blue', bidir: false, detail: '/api/notion-agent/health ‚Äî project summaries, actions, decisions for agent consumption.' },
  { from: 'sb-ops', to: 'notion-agents', label: 'Trial API', status: 'blue', bidir: false, detail: '/api/notion-agent/mission ‚Äî alerts, focus items, health metrics.' },
  { from: 'sb-memory', to: 'ai', label: 'Batch', status: 'green', bidir: true, detail: 'Vector embeddings (384-dim), hybrid memory search, knowledge graph traversal.' },
  { from: 'sb-projects', to: 'ai', label: 'Enrichment', status: 'green', bidir: true, detail: 'Project intelligence, daily briefing, sprint suggestions, email enrichment.' },
  { from: 'sb-learning', to: 'ai', label: 'Feedback', status: 'green', bidir: true, detail: 'Agent learning: feedback records, mistake patterns, confidence calibration.' },
  { from: 'sb-contacts', to: 'cron', label: 'Scheduled', status: 'green', bidir: true, detail: 'Contact signals (daily 3am), engagement status (daily 11am), reconciliation (every 6h).' },
  { from: 'sb-finance', to: 'cron', label: 'Scheduled', status: 'green', bidir: true, detail: 'Auto-tag transactions (daily 9:30am), data freshness (every 6h), finance‚ÜíNotion (daily 8:30am).' },
  { from: 'sb-grants', to: 'cron', label: 'Scheduled', status: 'green', bidir: true, detail: 'Enrich grants (daily 10:30am), check deadlines (every 6h), sync GHL (every 6h).' },
  // Special: blocked
  { from: 'sb-contacts', to: 'ghl', label: 'NEVER syncs', status: 'red', bidir: false, detail: 'cultural_protocols table intentionally NEVER syncs to GHL. OCAP compliance. This is CORRECT behavior.', special: 'block' },
];

// Duplication data
const duplications = [
  {
    domain: 'Contacts',
    icon: 'üë•',
    copies: [
      { system: 'GHL CRM', role: 'External-facing CRM. Email, phone, tags, engagement.', sot: 'primary', sotLabel: 'Source of Truth' },
      { system: 'Supabase', role: 'Enriched mirror + cultural_protocols + relationship_health.', sot: 'mirror', sotLabel: 'Enriched Mirror' },
      { system: 'Notion', role: 'Read-only view via People Directory database.', sot: 'mirror', sotLabel: 'Read-Only' },
    ],
    verdict: 'ok',
    analysis: 'Clean architecture. GHL is canonical for secular CRM data. Supabase adds cultural protocols (OCAP) and relationship scoring that never touch GHL. Notion is downstream read-only.'
  },
  {
    domain: 'Projects',
    icon: 'üìã',
    copies: [
      { system: 'Supabase', role: '59 canonical projects with codes, health scores, financials.', sot: 'primary', sotLabel: 'Source of Truth' },
      { system: 'Notion', role: '27 databases for daily work ‚Äî actions, decisions, meetings.', sot: 'sync', sotLabel: 'Bidirectional' },
      { system: 'GHL', role: 'Pipeline tags for project-linked opportunities.', sot: 'mirror', sotLabel: 'Tags Only' },
    ],
    verdict: 'warn',
    analysis: 'Risk area. Supabase owns project registry but Notion owns daily workflow. Bidirectional sync (every 5-15 min) creates potential for conflicts. If Notion agent modifies an action and ACT script modifies it simultaneously, last-write-wins.'
  },
  {
    domain: 'Actions & Decisions',
    icon: '‚úÖ',
    copies: [
      { system: 'Notion', role: 'Primary workspace ‚Äî created and managed here.', sot: 'primary', sotLabel: 'Source of Truth' },
      { system: 'Supabase', role: 'Mirror for API access, bot queries, analytics.', sot: 'sync', sotLabel: 'Bidirectional' },
    ],
    verdict: 'warn',
    analysis: 'Bidirectional sync every 15 min. Bot can create actions via add_action_item tool ‚Üí Supabase ‚Üí Notion. Checkbox polling syncs completions. Risk: race condition if Notion agent and bot both update same action.'
  },
  {
    domain: 'Financial Data',
    icon: 'üí∞',
    copies: [
      { system: 'Xero', role: 'Authoritative accounting system. Invoices, transactions.', sot: 'primary', sotLabel: 'Source of Truth' },
      { system: 'Supabase', role: 'Read-only mirror for dashboards, API, bot queries.', sot: 'mirror', sotLabel: 'Read-Only Mirror' },
    ],
    verdict: 'ok',
    analysis: 'Clean one-way sync via webhooks. Supabase never writes back to Xero. Auto-tagging adds project_code enrichment. No conflict risk.'
  },
  {
    domain: 'Calendar Events',
    icon: 'üìÖ',
    copies: [
      { system: 'Google Calendar', role: 'Primary calendar. Events created/edited here.', sot: 'primary', sotLabel: 'Source of Truth' },
      { system: 'Supabase', role: 'Mirror with project linking + attendee matching.', sot: 'mirror', sotLabel: 'Enriched Mirror' },
      { system: 'Notion', role: 'Deadlines published back to Calendar.', sot: 'sync', sotLabel: 'Outbound Only' },
    ],
    verdict: 'ok',
    analysis: 'Google Calendar is canonical. Supabase enriches with project codes and contact matching. Notion only pushes deadlines outbound ‚Äî no inbound sync from Calendar to Notion.'
  },
  {
    domain: 'Grant Opportunities',
    icon: 'üèõÔ∏è',
    copies: [
      { system: 'Supabase', role: 'Full pipeline: discovery, scoring, requirements, applications.', sot: 'primary', sotLabel: 'Source of Truth' },
      { system: 'GHL', role: 'Pipeline view for CRM-style stage tracking.', sot: 'sync', sotLabel: 'Bidirectional' },
      { system: 'Web Sources', role: 'Raw discovery via daily scraping.', sot: 'mirror', sotLabel: 'Ingest Only' },
    ],
    verdict: 'warn',
    analysis: 'Three-system sync chain: Web‚ÜíSupabase‚ÜíGHL. Stage changes in GHL sync back to Supabase. Risk: if stage is manually changed in GHL without corresponding Supabase update, they can drift. Pipeline IDs are hardcoded.'
  },
];

// Health data
const healthItems = [
  { status: 'green', icon: '‚úÖ', title: 'Xero Webhooks', detail: 'Real-time transaction ingestion. HMAC signature validation. Rock solid.' },
  { status: 'green', icon: '‚úÖ', title: 'Notion 5-min Sync', detail: 'Incremental sync via last_edited_time. 100-item batches. Actions/decisions every 15 min.' },
  { status: 'green', icon: '‚úÖ', title: 'GHL Bidirectional', detail: 'Webhooks for instant + hourly cron fallback. Cultural protocol enforcement at 2 layers.' },
  { status: 'green', icon: '‚úÖ', title: 'Telegram Bot', detail: '40 tools, all operational. Confirmation flow for writes. Haiku model (<$1/week).' },
  { status: 'green', icon: '‚úÖ', title: 'Calendar Sync', detail: 'Etag-based incremental sync. Project code auto-detection. Attendee matching.' },
  { status: 'green', icon: '‚úÖ', title: 'iMessage Sync', detail: 'Every 15 min from local SQLite. OCR on attachments. Vector embeddings generated.' },
  { status: 'green', icon: '‚úÖ', title: 'Knowledge Pipeline', detail: 'Daily processing: emails‚Üíknowledge, embedding generation, knowledge graph edges.' },
  { status: 'green', icon: '‚úÖ', title: 'Auto-Tagging', detail: 'Vendor rules (45 rules), keyword matching, tracking code matching. 3-tier cascade.' },
  { status: 'orange', icon: '‚ö†Ô∏è', title: 'Gmail Sync', detail: '90-day backfill is very slow (4K+ messages for benjamin alone). DNS failures under load.', fix: 'Use targeted Gmail API queries with q parameter instead of full sync for searches.' },
  { status: 'orange', icon: '‚ö†Ô∏è', title: 'Grant Enrichment', detail: '8 gov.au grant URLs return 403/404. Browser UA workaround partially helps.', fix: 'Manual URL updates needed for blocked grants. Consider using a headless browser.' },
  { status: 'orange', icon: '‚ö†Ô∏è', title: 'Entity Deduplication', detail: 'canonical_entities schema exists but is not actively running. Potential duplicates accumulating.', fix: 'Activate reconcile-contacts.mjs cron. Review entity_potential_matches table.' },
  { status: 'orange', icon: '‚ö†Ô∏è', title: 'Hardcoded GHL IDs', detail: 'Pipeline IDs, stage IDs, custom field IDs hardcoded in sync scripts. Fragile on GHL schema changes.', fix: 'Move to config/ghl-mappings.json or fetch dynamically from GHL API on startup.' },
  { status: 'red', icon: 'üî¥', title: 'Contact Auto-Create', detail: 'ghl_contacts missing "source" column blocks auto-creation of new contacts during Gmail sync.', fix: 'Add source column to ghl_contacts table. Non-blocking: sync still works, just can\'t create contacts.' },
  { status: 'red', icon: 'üî¥', title: 'Gov.au Grants (8 URLs)', detail: '8 grant opportunity URLs return 403/404. Enrichment blocked for these grants.', fix: 'Manual URL verification and update needed. These may have moved or expired.' },
  { status: 'blue', icon: 'üîµ', title: 'Notion Agents (Trial)', detail: '3 agents configured: Sprint Standup (daily), Meeting Prep (on create), Project Health (weekly). API endpoints deployed.', fix: 'Monitor via /api/notion-agent/trials. Decision gate: >95% success rate for Phase 2.' },
  { status: 'blue', icon: 'üîµ', title: 'Sprint Suggestions', detail: '5-signal generator: grants, actions, emails, calendar, insights. 3x daily cron.', fix: 'New system. Monitor suggestion quality and accept/dismiss rates in dashboard.' },
];

// Agentic data
const agentCurrent = [
  { title: 'Telegram Bot ‚Äî Full Domain Access', desc: '40 tools across contacts, finance, projects, grants, calendar, knowledge. 21 read + 5 write + 7 knowledge capture + 3 governance.' },
  { title: 'Email Enrichment', desc: 'AI summarization, sentiment analysis, topic extraction, action item detection on every synced email.' },
  { title: 'Grant Scoring', desc: 'Claude scores fit (0-100), eligibility, and generates assessment for each discovered grant. Auto-creates applications for fit‚â•70.' },
  { title: 'Project Intelligence', desc: 'Daily AI narratives per project. Health scoring across 5 dimensions (overall, momentum, engagement, financial, timeline).' },
  { title: 'Transaction Auto-Tagging', desc: '3-tier cascade: vendor rules (45 rules) ‚Üí tracking code match ‚Üí keyword match. project_code_source tracks attribution.' },
  { title: 'Email Auto-Tagging', desc: 'NLP-based project code assignment for emails. Runs every 6h+15min after Gmail sync.' },
  { title: 'Sprint Suggestions', desc: '5-signal generator: grant deadlines, overdue actions, stale emails, calendar deadlines, new insights. 3x daily.' },
  { title: 'Relationship Health', desc: 'Temperature scoring (0-100), LCAA stage tracking, auto-updated on new communications. Contact signals computed daily.' },
  { title: 'Knowledge Graph', desc: 'Hybrid memory search: vector similarity + graph traversal + decay scoring. 10 edge types connecting knowledge across domains.' },
  { title: 'Daily Briefing', desc: '7-section morning summary: priorities, overdue, meetings, relationships, finances, grants, sprint suggestions.' },
];

const agentOpportunities = [
  { title: 'Auto-Draft Email Responses', desc: 'For routine emails (meeting confirmations, simple queries), draft a response and queue for confirmation. Reduces inbox processing time.', priority: 'high' },
  { title: 'Calendar Events from Email Context', desc: 'When emails mention dates/meetings, auto-create calendar events with attendees and project linking. Currently manual.', priority: 'high' },
  { title: 'Auto-Link Contacts to Projects', desc: 'When a new email arrives from a contact, infer project affiliation from content and auto-tag. Currently only manual or tag-based.', priority: 'med' },
  { title: 'Relationship Health Escalation', desc: 'When relationship temperature drops below threshold, proactively alert via Telegram with context and suggested action.', priority: 'high' },
  { title: 'Proactive Grant Deadline Warnings', desc: 'Telegram push notifications N days before grant deadlines with readiness score and missing requirements. Currently passive.', priority: 'high' },
  { title: 'Auto-Reconcile Receipts', desc: 'Match scanned receipts to Xero transactions using AI (date, amount, vendor). Currently manual matching.', priority: 'med' },
  { title: 'Notion Agent: Project Status from Comms', desc: 'When significant emails arrive about a project, auto-update project status/notes in Notion. Currently requires manual update.', priority: 'med' },
  { title: 'Notion Agent: Action Items from Meetings', desc: 'After meeting notes are created, auto-extract action items and create them in the Actions database.', priority: 'high' },
  { title: 'Cross-System Entity Resolution', desc: 'Activate canonical_entities deduplication. Auto-merge contacts appearing across GHL, Gmail, Calendar with different names/emails.', priority: 'med' },
  { title: 'Autonomous Weekly Digest', desc: 'Generate and push weekly digest to Telegram without manual trigger. Include trends, anomalies, and recommendations.', priority: 'low' },
  { title: 'Financial Anomaly Detection', desc: 'Flag unusual transactions (amount, category, timing) and alert via bot. Currently no anomaly detection.', priority: 'med' },
  { title: 'Auto-Create Notion Pages from Voice Notes', desc: 'When voice notes are captured via Telegram, auto-create structured Notion page with transcript, project link, action items.', priority: 'low' },
];

// Process data
const processes = [
  {
    title: 'New Contact ‚Üí Engaged Partner',
    subtitle: 'Lifecycle from first touch to active collaboration',
    steps: [
      { label: 'GHL contact created', type: 'external' },
      { label: 'Webhook fires', type: 'external' },
      { label: 'ghl_contacts upsert', type: 'supabase' },
      { label: 'relationship_health init', type: 'supabase' },
      { label: 'Communications tracked', type: 'supabase' },
      { label: 'engagement_status ‚Üí active', type: 'supabase' },
      { label: 'Project linked', type: 'supabase' },
      { label: 'Notion visibility', type: 'output' },
      { label: 'Bot queryable', type: 'output' },
    ],
    latency: 'Webhook: <1s | Full enrichment: ~3 hours (next cron)',
    frequency: 'On contact creation + daily signal refresh',
  },
  {
    title: 'Grant Discovery ‚Üí Submission',
    subtitle: 'From web scrape to lodged application',
    steps: [
      { label: 'Web scrape', type: 'external' },
      { label: 'grant_opportunities', type: 'supabase' },
      { label: 'AI scoring (Claude)', type: 'ai' },
      { label: 'Auto-create app (fit‚â•70)', type: 'supabase' },
      { label: 'GHL pipeline sync', type: 'external' },
      { label: 'Requirements tracking', type: 'supabase' },
      { label: 'Asset matching', type: 'supabase' },
      { label: 'Draft preparation', type: 'output' },
      { label: 'Submission', type: 'output' },
    ],
    latency: 'Discovery‚ÜíScore: ~24h | Score‚ÜíApplication: immediate if fit‚â•70',
    frequency: 'Daily discovery + daily enrichment (batch 20)',
    issues: '8 gov.au URLs blocked (403/404)',
  },
  {
    title: 'Financial Transaction ‚Üí Project Insight',
    subtitle: 'From bank feed to project-level financial analysis',
    steps: [
      { label: 'Xero webhook', type: 'external' },
      { label: 'xero_transactions upsert', type: 'supabase' },
      { label: 'Vendor rule matching', type: 'ai' },
      { label: 'project_code tagged', type: 'supabase' },
      { label: 'v_project_financials', type: 'supabase' },
      { label: 'Dashboard visible', type: 'output' },
      { label: 'Bot queryable', type: 'output' },
    ],
    latency: 'Webhook: real-time | Auto-tag: next daily cron (9:30am)',
    frequency: 'Webhooks real-time + daily auto-tagging',
  },
  {
    title: 'Knowledge Capture ‚Üí Retrieval',
    subtitle: 'From diverse inputs to semantic search and daily briefing',
    steps: [
      { label: 'Notion / Email / Voice / Meeting', type: 'external' },
      { label: 'project_knowledge', type: 'supabase' },
      { label: 'Vector embedding (384-dim)', type: 'ai' },
      { label: 'knowledge_edges graph', type: 'supabase' },
      { label: 'hybrid_memory_search', type: 'ai' },
      { label: 'Bot retrieval', type: 'output' },
      { label: 'Daily briefing', type: 'output' },
    ],
    latency: 'Notion: 5 min | Email: 6h | Embedding: next daily pipeline (8am)',
    frequency: 'Continuous ingestion + daily processing + on-demand search',
  },
];


// ============================================================
// TAB SWITCHING
// ============================================================

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});


// ============================================================
// TAB 1: LIVE DATA FLOW (SVG)
// ============================================================

let selectedNode = null;
const svg = document.getElementById('flow-svg');
const tooltip = document.getElementById('tooltip');

function drawFlowDiagram() {
  const W = 960, H = 800;
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

  // Arrow markers
  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  ['#10b981','#f59e0b','#ef4444','#3b82f6','#64748b'].forEach((c, i) => {
    const m = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
    m.setAttribute('id', 'arr-' + i);
    m.setAttribute('markerWidth', '8');
    m.setAttribute('markerHeight', '6');
    m.setAttribute('refX', '7');
    m.setAttribute('refY', '3');
    m.setAttribute('orient', 'auto');
    const p = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
    p.setAttribute('points', '0 0, 8 3, 0 6');
    p.setAttribute('fill', c);
    m.appendChild(p);
    defs.appendChild(m);
  });
  svg.appendChild(defs);

  // Column labels
  addText(svg, 120, 28, 'EXTERNAL SOURCES', '#64748b', 11, 'bold');
  addText(svg, 480, 28, 'SUPABASE (65+ tables)', '#64748b', 11, 'bold');
  addText(svg, 830, 28, 'CONSUMERS', '#64748b', 11, 'bold');

  // Draw connections first (under nodes)
  connections.forEach(conn => {
    const fromNode = findNode(conn.from);
    const toNode = findNode(conn.to);
    if (!fromNode || !toNode) return;

    const statusColors = { green: '#10b981', orange: '#f59e0b', red: '#ef4444', blue: '#3b82f6' };
    const markerIds = { green: 'arr-0', orange: 'arr-1', red: 'arr-2', blue: 'arr-3' };
    const color = statusColors[conn.status] || '#64748b';
    const markerId = markerIds[conn.status] || 'arr-4';

    const fBox = getNodeBox(fromNode);
    const tBox = getNodeBox(toNode);

    let x1, y1, x2, y2;
    if (fBox.cx < tBox.cx) {
      x1 = fBox.x + fBox.w; y1 = fBox.cy;
      x2 = tBox.x; y2 = tBox.cy;
    } else {
      x1 = fBox.x; y1 = fBox.cy;
      x2 = tBox.x + tBox.w; y2 = tBox.cy;
    }

    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    const mx = (x1 + x2) / 2;
    path.setAttribute('d', `M${x1},${y1} C${mx},${y1} ${mx},${y2} ${x2},${y2}`);
    path.setAttribute('fill', 'none');
    path.setAttribute('stroke', color);
    path.setAttribute('stroke-width', conn.special === 'block' ? '2' : '1.5');
    path.setAttribute('opacity', '0.5');
    path.setAttribute('marker-end', `url(#${markerId})`);
    if (conn.status === 'red') path.setAttribute('stroke-dasharray', '6,4');
    if (conn.status === 'blue') path.setAttribute('stroke-dasharray', '8,4');
    path.dataset.from = conn.from;
    path.dataset.to = conn.to;
    path.classList.add('conn-line');

    path.addEventListener('mouseenter', (e) => showTooltip(e, `<h4>${conn.label}</h4><div class="detail">${conn.detail}</div><span class="tag tag-${conn.status}">${conn.status.toUpperCase()}</span>${conn.bidir ? ' <span class="tag tag-blue">BIDIRECTIONAL</span>' : ''}`));
    path.addEventListener('mouseleave', hideTooltip);
    svg.appendChild(path);

    if (conn.special === 'block') {
      const blockX = mx, blockY = (y1 + y2) / 2;
      addText(svg, blockX, blockY - 4, '‚úï', '#ef4444', 14, 'bold');
    }
  });

  // Draw source nodes
  sources.forEach(n => drawSourceNode(n));
  // Draw Supabase domain nodes
  supaDomains.forEach(n => drawSupaNode(n));
  // Draw consumer nodes
  consumers.forEach(n => drawConsumerNode(n));
}

function findNode(id) {
  return sources.find(n => n.id === id) || supaDomains.find(n => n.id === id) || consumers.find(n => n.id === id);
}

function getNodeBox(n) {
  if (sources.includes(n)) return { x: n.x, y: n.y, w: 160, h: 50, cx: n.x + 80, cy: n.y + 25 };
  if (supaDomains.includes(n)) return { x: n.x, y: n.y, w: 200, h: 50, cx: n.x + 100, cy: n.y + 25 };
  return { x: n.x, y: n.y, w: 160, h: 50, cx: n.x + 80, cy: n.y + 25 };
}

function drawSourceNode(n) {
  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.classList.add('node');
  g.dataset.id = n.id;

  const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  rect.setAttribute('x', n.x); rect.setAttribute('y', n.y);
  rect.setAttribute('width', 160); rect.setAttribute('height', 50);
  rect.setAttribute('rx', 8);
  rect.setAttribute('fill', '#111118');
  rect.setAttribute('stroke', n.color + '66');
  rect.setAttribute('stroke-width', '1.5');
  g.appendChild(rect);

  addText(g, n.x + 30, n.y + 22, n.label, '#f1f5f9', 12, '600');
  addText(g, n.x + 30, n.y + 38, n.sub, '#64748b', 10);
  addText(g, n.x + 12, n.y + 24, n.icon, null, 14);

  g.addEventListener('click', () => highlightNode(n.id));
  g.addEventListener('mouseenter', (e) => {
    const conns = connections.filter(c => c.from === n.id || c.to === n.id);
    const html = `<h4>${n.icon} ${n.label}</h4><div class="detail">${n.sub}<br>${conns.length} connections</div>`;
    showTooltip(e, html);
  });
  g.addEventListener('mouseleave', hideTooltip);
  g.style.cursor = 'pointer';
  svg.appendChild(g);
}

function drawSupaNode(n) {
  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.classList.add('node');
  g.dataset.id = n.id;

  const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  rect.setAttribute('x', n.x); rect.setAttribute('y', n.y);
  rect.setAttribute('width', 200); rect.setAttribute('height', 50);
  rect.setAttribute('rx', 8);
  rect.setAttribute('fill', '#0f1419');
  rect.setAttribute('stroke', n.color + '44');
  rect.setAttribute('stroke-width', '1.5');
  g.appendChild(rect);

  const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  bar.setAttribute('x', n.x); bar.setAttribute('y', n.y);
  bar.setAttribute('width', 4); bar.setAttribute('height', 50);
  bar.setAttribute('rx', 2);
  bar.setAttribute('fill', n.color);
  g.appendChild(bar);

  addText(g, n.x + 14, n.y + 22, n.label, '#f1f5f9', 12, '600');
  addText(g, n.x + 14, n.y + 38, n.sub, '#64748b', 10);

  g.addEventListener('click', () => highlightNode(n.id));
  g.addEventListener('mouseenter', (e) => {
    const conns = connections.filter(c => c.from === n.id || c.to === n.id);
    const html = `<h4>${n.label}</h4><div class="detail">${n.sub}<br><br><b>Tables:</b> ${n.tables}<br><br>${conns.length} connections</div>`;
    showTooltip(e, html);
  });
  g.addEventListener('mouseleave', hideTooltip);
  g.style.cursor = 'pointer';
  svg.appendChild(g);
}

function drawConsumerNode(n) {
  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.classList.add('node');
  g.dataset.id = n.id;

  const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  rect.setAttribute('x', n.x); rect.setAttribute('y', n.y);
  rect.setAttribute('width', 160); rect.setAttribute('height', 50);
  rect.setAttribute('rx', 8);
  rect.setAttribute('fill', '#111118');
  rect.setAttribute('stroke', n.color + '44');
  rect.setAttribute('stroke-width', '1.5');
  g.appendChild(rect);

  addText(g, n.x + 30, n.y + 22, n.label, '#f1f5f9', 12, '600');
  addText(g, n.x + 30, n.y + 38, n.sub, '#64748b', 10);
  addText(g, n.x + 12, n.y + 24, n.icon, null, 14);

  g.addEventListener('click', () => highlightNode(n.id));
  g.addEventListener('mouseenter', (e) => {
    const conns = connections.filter(c => c.from === n.id || c.to === n.id);
    const html = `<h4>${n.icon} ${n.label}</h4><div class="detail">${n.sub}<br>${conns.length} connections</div>`;
    showTooltip(e, html);
  });
  g.addEventListener('mouseleave', hideTooltip);
  g.style.cursor = 'pointer';
  svg.appendChild(g);
}

function addText(parent, x, y, text, fill, size, weight) {
  const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  t.setAttribute('x', x); t.setAttribute('y', y);
  if (fill) t.setAttribute('fill', fill);
  t.setAttribute('font-size', size || 12);
  if (weight) t.setAttribute('font-weight', weight);
  t.setAttribute('font-family', '-apple-system, BlinkMacSystemFont, system-ui, sans-serif');
  t.textContent = text;
  parent.appendChild(t);
  return t;
}

function highlightNode(id) {
  if (selectedNode === id) {
    // Deselect
    selectedNode = null;
    svg.querySelectorAll('.conn-line').forEach(l => { l.setAttribute('opacity', '0.5'); l.setAttribute('stroke-width', '1.5'); });
    svg.querySelectorAll('.node rect:first-child').forEach(r => r.setAttribute('stroke-width', '1.5'));
    return;
  }
  selectedNode = id;
  const related = connections.filter(c => c.from === id || c.to === id);
  const relatedIds = new Set();
  related.forEach(c => { relatedIds.add(c.from); relatedIds.add(c.to); });

  svg.querySelectorAll('.conn-line').forEach(l => {
    const isRelated = related.some(c => c.from === l.dataset.from && c.to === l.dataset.to);
    l.setAttribute('opacity', isRelated ? '0.9' : '0.08');
    l.setAttribute('stroke-width', isRelated ? '2.5' : '1');
  });

  svg.querySelectorAll('.node').forEach(g => {
    const nodeId = g.dataset.id;
    const rect = g.querySelector('rect');
    if (nodeId === id) {
      rect.setAttribute('stroke-width', '3');
    } else if (relatedIds.has(nodeId)) {
      rect.setAttribute('stroke-width', '2');
    } else {
      rect.setAttribute('stroke-width', '0.5');
    }
  });
}

function showTooltip(e, html) {
  tooltip.innerHTML = html;
  tooltip.classList.add('show');
  const x = Math.min(e.clientX + 12, window.innerWidth - 340);
  const y = Math.min(e.clientY + 12, window.innerHeight - 200);
  tooltip.style.left = x + 'px';
  tooltip.style.top = y + 'px';
}

function hideTooltip() {
  tooltip.classList.remove('show');
}


// ============================================================
// TAB 2: DUPLICATION ANALYSIS
// ============================================================

function renderDuplication() {
  const grid = document.getElementById('dup-grid');
  grid.innerHTML = duplications.map(d => `
    <div class="dup-card">
      <h3>${d.icon} ${d.domain}</h3>
      <div class="copies">
        ${d.copies.map(c => `
          <div class="copy-row">
            <span class="system">${c.system}</span>
            <span class="role">${c.role}</span>
            <span class="sot sot-${c.sot}">${c.sotLabel}</span>
          </div>
        `).join('')}
      </div>
      <div class="dup-verdict verdict-${d.verdict}">
        ${d.analysis}
      </div>
    </div>
  `).join('');
}


// ============================================================
// TAB 3: HEALTH ASSESSMENT
// ============================================================

function renderHealth() {
  const grid = document.getElementById('health-grid');
  const order = ['red', 'orange', 'blue', 'green'];
  const sorted = [...healthItems].sort((a, b) => order.indexOf(a.status) - order.indexOf(b.status));
  grid.innerHTML = sorted.map(h => `
    <div class="health-card health-${h.status}">
      <div class="health-icon">${h.icon}</div>
      <div class="health-info">
        <h4>${h.title}</h4>
        <p>${h.detail}</p>
        ${h.fix ? `<p class="fix">‚Üí ${h.fix}</p>` : ''}
      </div>
    </div>
  `).join('');
}


// ============================================================
// TAB 4: AGENTIC OPPORTUNITIES
// ============================================================

function renderAgentic() {
  const wrap = document.getElementById('agent-wrap');
  wrap.innerHTML = `
    <div class="agent-section">
      <h3><span style="color:#10b981">‚óè</span> Active AI Agent Touchpoints <span class="count">(${agentCurrent.length} active)</span></h3>
      <div class="agent-grid">
        ${agentCurrent.map(a => `
          <div class="agent-item">
            <div class="agent-dot dot-active"></div>
            <div>
              <h5>${a.title}</h5>
              <p>${a.desc}</p>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
    <div class="agent-section">
      <h3><span style="color:#f59e0b">‚óè</span> Opportunity Gaps ‚Äî Where Agents Could Act <span class="count">(${agentOpportunities.length} identified)</span></h3>
      <div class="agent-grid">
        ${agentOpportunities.map(a => `
          <div class="agent-item">
            <div class="agent-dot dot-opportunity"></div>
            <div>
              <h5>${a.title} <span class="priority-badge pri-${a.priority}">${a.priority.toUpperCase()}</span></h5>
              <p>${a.desc}</p>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}


// ============================================================
// TAB 5: PROCESS MAPS
// ============================================================

function renderProcesses() {
  const wrap = document.getElementById('process-wrap');
  wrap.innerHTML = processes.map(p => `
    <div class="process-card">
      <h3>${p.title}</h3>
      <div class="subtitle">${p.subtitle}</div>
      <div class="process-steps">
        ${p.steps.map((s, i) => `
          <span class="process-step step-${s.type}">${s.label}</span>
          ${i < p.steps.length - 1 ? '<span class="process-arrow">‚Üí</span>' : ''}
        `).join('')}
      </div>
      <div class="process-meta">
        <span>‚è± ${p.latency}</span>
        <span>üîÑ ${p.frequency}</span>
        ${p.issues ? `<span style="color:#f59e0b">‚ö† ${p.issues}</span>` : ''}
      </div>
    </div>
  `).join('');
}


// ============================================================
// PROMPT OUTPUT
// ============================================================

function updatePrompt() {
  const greenCount = healthItems.filter(h => h.status === 'green').length;
  const orangeCount = healthItems.filter(h => h.status === 'orange').length;
  const redCount = healthItems.filter(h => h.status === 'red').length;
  const blueCount = healthItems.filter(h => h.status === 'blue').length;
  const dupWarn = duplications.filter(d => d.verdict === 'warn').length;

  document.getElementById('prompt-text').textContent = `ACT Ecosystem Audit Summary
===========================

Architecture: 8 external systems ‚Üí Supabase (65+ tables) ‚Üí 5 consumer layers
Scale: 200K+ rows, 163 API routes, 40 bot tools, 28 cron jobs

Health: ${greenCount} healthy | ${orangeCount} attention | ${redCount} blocked | ${blueCount} trial
Duplication: ${dupWarn} domains with conflict risk (Projects, Actions, Grants)

BLOCKED (fix now):
- ghl_contacts missing "source" column ‚Äî blocks contact auto-creation
- 8 gov.au grant URLs returning 403/404

NEEDS ATTENTION:
- Gmail 90-day sync is slow + DNS failures under load
- GHL pipeline/stage IDs hardcoded ‚Äî fragile
- Entity deduplication schema exists but inactive

HIGH-PRIORITY AGENTIC GAPS:
1. Auto-draft email responses (routine confirmations)
2. Relationship health escalation alerts
3. Proactive grant deadline push notifications
4. Notion agent: auto-create actions from meeting notes

DUPLICATION RISKS:
- Projects: Supabase (registry) ‚Üî Notion (workflow) ‚Äî bidirectional sync could conflict
- Actions: Notion (primary) ‚Üî Supabase (mirror) ‚Äî race conditions with bot writes
- Grants: Web ‚Üí Supabase ‚Üí GHL ‚Äî stage changes can drift

WORKING WELL:
- Xero webhooks (real-time, HMAC validated)
- GHL bidirectional with cultural protocol enforcement
- Notion 5-min sync with incremental detection
- Knowledge pipeline (vector + graph + decay scoring)
- Transaction auto-tagging (3-tier cascade, 45 vendor rules)`;
}

function togglePrompt() {
  document.getElementById('prompt-panel').classList.toggle('show');
}

function copyPrompt() {
  const text = document.getElementById('prompt-text').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.querySelector('.copy-btn');
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy', 1500);
  });
}


// ============================================================
// INIT
// ============================================================

drawFlowDiagram();
renderDuplication();
renderHealth();
renderAgentic();
renderProcesses();
updatePrompt();
</script>
</body>
</html>
