version: '3.8'

services:
  clawdbot:
    build: .
    container_name: clawdbot-farmhand
    restart: unless-stopped
    ports:
      - "18789:18789"
    volumes:
      # Persistent config and data
      - clawdbot-config:/root/.clawdbot
      - clawdbot-workspace:/root/clawd
      # Voice notes storage
      - clawdbot-voice:/root/clawd/voice-notes
    environment:
      # Secrets - load from .env file
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GOOGLE_SERVICE_ACCOUNT_KEY=${GOOGLE_SERVICE_ACCOUNT_KEY}
      - GOOGLE_DELEGATED_USER=${GOOGLE_DELEGATED_USER}
      - NOTION_TOKEN=${NOTION_TOKEN}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - EL_SUPABASE_URL=${EL_SUPABASE_URL}
      - EL_SUPABASE_SERVICE_ROLE_KEY=${EL_SUPABASE_SERVICE_ROLE_KEY}
      - GHL_API_KEY=${GHL_API_KEY}
      - GHL_LOCATION_ID=${GHL_LOCATION_ID}
      # Signal API connection
      - SIGNAL_API_URL=http://signal-api:8080
    depends_on:
      - signal-api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Signal Messenger API
  # Provides REST API for Signal messaging
  # First-time setup: docker exec -it signal-api signal-cli -u +61XXXXXXXXX register
  signal-api:
    image: bbernhard/signal-cli-rest-api:latest
    container_name: signal-api
    restart: unless-stopped
    ports:
      - "8080:8080"  # Internal API
    volumes:
      - signal-data:/home/.local/share/signal-cli
    environment:
      - MODE=native  # Use native signal-cli (not json-rpc)
      - AUTO_RECEIVE_SCHEDULE=0 */5 * * * *  # Poll every 5 minutes
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/about"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  clawdbot-config:
  clawdbot-workspace:
  clawdbot-voice:
  signal-data:
